<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìä Resultado da Confer√™ncia</title>
    <!-- ‚úÖ ADICIONAR ESTA LINHA: -->
    <script src="js/config.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header */
      header {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      h1 {
        font-size: 2rem;
        color: var(--cor-loteria, #667eea);
        margin: 0;
      }

      .btn-voltar {
        padding: 12px 24px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: opacity 0.3s;
      }

      .btn-voltar:hover {
        opacity: 0.9;
      }

      /* Jogo Consultado */
      .jogo-consultado {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .jogo-consultado h2 {
        font-size: 1.3rem;
        color: #333;
        margin-bottom: 20px;
      }

      .jogo-consultado-info {
        color: #666;
        margin-bottom: 15px;
        font-size: 1rem;
      }

      .numeros-jogo {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .bola-jogo {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--cor-loteria, #667eea);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
      }

      /* Resumo */
      .resumo-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .resumo-container h2 {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 20px;
      }

      .resumo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .resumo-item {
        background: var(--cor-loteria, #667eea);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .resumo-qtd {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .resumo-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* Detalhes */
      .detalhes-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .detalhes-container h2 {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 20px;
      }

      .concurso-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 5px solid var(--cor-loteria, #667eea);
      }

      .concurso-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .concurso-numero {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--cor-loteria, #667eea);
      }

      .concurso-data {
        color: #666;
        font-size: 0.95rem;
      }

      .acertos-badge {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 1rem;
        background: #4caf50;
        color: white;
      }

      .numeros-sorteados {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .bola-sorteada {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
      }

      .bola-sorteada.acertou {
        background: #4caf50;
        color: white;
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: white;
        font-size: 1.5rem;
      }

      .loading::after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }

      .erro-container {
        background: white;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .erro-container h2 {
        color: #f44336;
        margin-bottom: 15px;
      }

      /* Responsivo */
      @media (max-width: 768px) {
        h1 {
          font-size: 1.5rem;
        }

        .jogo-consultado,
        .resumo-container,
        .detalhes-container {
          padding: 20px;
        }

        .bola-jogo {
          width: 40px;
          height: 40px;
          font-size: 0.95rem;
        }

        .bola-sorteada {
          width: 32px;
          height: 32px;
          font-size: 0.8rem;
        }

        .resumo-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .concurso-card {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header>
        <div class="header-content">
          <h1 id="titulo-loteria">Resultado da Confer√™ncia</h1>
          <a href="conferir.html" class="btn-voltar">‚Üê Nova Consulta</a>
        </div>
      </header>

      <!-- Loading -->
      <div id="loading" class="loading">Processando resultado</div>

      <!-- Erro -->
      <div id="erro-container" class="erro-container" style="display: none">
        <h2>‚ùå Erro ao Carregar</h2>
        <p>N√£o foi poss√≠vel carregar o resultado da confer√™ncia.</p>
        <br />
        <a href="conferir.html" class="btn-voltar">‚Üê Voltar</a>
      </div>

      <!-- Jogo Consultado -->
      <div id="jogo-consultado" class="jogo-consultado" style="display: none">
        <h2>Jogo Consultado</h2>
        <p class="jogo-consultado-info">
          Seu Jogo (<span id="qtd-dezenas">0</span> dezenas):
        </p>
        <div class="numeros-jogo" id="numeros-jogo"></div>
      </div>

      <!-- Resumo -->
      <div id="resumo-container" class="resumo-container" style="display: none">
        <h2>üìä Resumo: Acertos por Concurso</h2>
        <div class="resumo-grid" id="resumo-grid"></div>
      </div>

      <!-- Detalhes -->
      <div
        id="detalhes-container"
        class="detalhes-container"
        style="display: none"
      >
        <h2>üéØ Detalhes dos Acertos</h2>
        <div id="concursos-list"></div>
      </div>
    </div>

    <script>
      // ‚úÖ Pegar token
      function getToken() {
        return localStorage.getItem("token");
      }

      // ‚úÖ Criar headers
      function getHeaders() {
        const token = getToken();
        return {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };
      }

      // ‚úÖ Verificar autentica√ß√£o
      function verificarAutenticacao() {
        const token = getToken();
        if (!token) {
          alert("Voc√™ precisa fazer login!");
          window.location.href = "login.html";
          return false;
        }
        return true;
      }

      async function carregarResultado() {
        // ‚úÖ Verificar autentica√ß√£o
        if (!verificarAutenticacao()) return;
        try {
          // Pegar dados do localStorage
          const dadosJogo = localStorage.getItem("conferencia_jogo");

          if (!dadosJogo) {
            throw new Error("Dados n√£o encontrados");
          }

          const jogo = JSON.parse(dadosJogo);

          // Aplicar cor da loteria
          document.documentElement.style.setProperty("--cor-loteria", jogo.cor);
          document.getElementById(
            "titulo-loteria"
          ).textContent = `Resultado - ${jogo.nomeLoteria}`;

          // ‚úÖ Buscar concursos da API COM TOKEN
          const response = await fetch(
            `${API_URL}${jogo.endpoint}?limit=1000`,
            {
              headers: getHeaders(),
            }
          );

          // ‚úÖ Verificar se a resposta √© OK
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error("Sess√£o expirada. Fa√ßa login novamente.");
            } else if (response.status === 403) {
              throw new Error("Recurso dispon√≠vel apenas para usu√°rios PR√ì.");
            }
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
          }
          const data = await response.json();

          if (!data.success) {
            throw new Error(data.message || "Erro ao buscar concursos");
          }

          // Processar resultados
          const resultados = conferirAcertos(jogo.numeros, data.data, jogo.min);

          // Mostrar resultado
          mostrarResultado(jogo, resultados);
        } catch (error) {
          console.error("Erro:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("erro-mensagem").textContent = error.message;
          document.getElementById("erro-container").style.display = "block";
        }
      }

      function conferirAcertos(meuJogo, concursos, min) {
        const resultados = [];

        concursos.forEach((concurso) => {
          const dezenas = concurso.dezenas || [];
          const acertos = meuJogo.filter((num) => dezenas.includes(num));

          if (acertos.length > 0) {
            resultados.push({
              concurso: concurso.concurso,
              data: concurso.created_at,
              dezenas: dezenas,
              acertos: acertos,
              qtdAcertos: acertos.length,
            });
          }
        });

        resultados.sort((a, b) => b.qtdAcertos - a.qtdAcertos);
        return resultados;
      }

      function mostrarResultado(jogo, resultados) {
        document.getElementById("loading").style.display = "none";

        // Jogo Consultado
        document.getElementById("qtd-dezenas").textContent =
          jogo.numeros.length;
        const numerosDiv = document.getElementById("numeros-jogo");
        numerosDiv.innerHTML = "";

        jogo.numeros
          .sort((a, b) => a - b)
          .forEach((num) => {
            const bola = document.createElement("div");
            bola.className = "bola-jogo";
            const texto =
              jogo.min === 0 ? num.toString().padStart(2, "0") : num;
            bola.textContent = texto;
            numerosDiv.appendChild(bola);
          });

        document.getElementById("jogo-consultado").style.display = "block";

        // Resumo
        const resumo = {};
        resultados.forEach((r) => {
          resumo[r.qtdAcertos] = (resumo[r.qtdAcertos] || 0) + 1;
        });

        const resumoDiv = document.getElementById("resumo-grid");
        resumoDiv.innerHTML = "";

        // Ordenar do maior para o menor
        Object.keys(resumo)
          .sort((a, b) => b - a)
          .forEach((qtd) => {
            const item = document.createElement("div");
            item.className = "resumo-item";
            item.innerHTML = `
                    <div class="resumo-qtd">${resumo[qtd]}</div>
                    <div class="resumo-label">${qtd} acerto${
              qtd > 1 ? "s" : ""
            }</div>
                `;
            resumoDiv.appendChild(item);
          });

        document.getElementById("resumo-container").style.display = "block";

        // Detalhes (primeiros 50)
        const concursosList = document.getElementById("concursos-list");
        concursosList.innerHTML = "";

        resultados.slice(0, 50).forEach((resultado) => {
          const card = document.createElement("div");
          card.className = "concurso-card";

          const dezenasHTML = resultado.dezenas
            .map((num) => {
              const acertou = resultado.acertos.includes(num);
              const texto =
                jogo.min === 0 ? num.toString().padStart(2, "0") : num;
              return `<div class="bola-sorteada ${
                acertou ? "acertou" : ""
              }">${texto}</div>`;
            })
            .join("");

          card.innerHTML = `
                    <div class="concurso-header">
                        <div>
                            <div class="concurso-numero">Concurso #${
                              resultado.concurso
                            }</div>
                        </div>
                        <div class="acertos-badge">
                            ${resultado.qtdAcertos} acerto${
            resultado.qtdAcertos > 1 ? "s" : ""
          }
                        </div>
                    </div>
                    <div class="numeros-sorteados">
                        ${dezenasHTML}
                    </div>
                `;

          concursosList.appendChild(card);
        });

        if (resultados.length > 50) {
          const aviso = document.createElement("div");
          aviso.style.textAlign = "center";
          aviso.style.padding = "20px";
          aviso.style.color = "#666";
          aviso.textContent = `Mostrando os primeiros 50 resultados. Total de acertos: ${resultados.length}`;
          concursosList.appendChild(aviso);
        }

        document.getElementById("detalhes-container").style.display = "block";
      }

      // ‚úÖ Carregar ao iniciar (ap√≥s verificar auth)
      carregarResultado();
    </script>
    <script src="js/auth-check.js"></script>
  </body>
</html>
