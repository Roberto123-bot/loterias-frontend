<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üíæ Meus Jogos - Sistema de Loterias</title>
    <!-- ‚úÖ ADICIONAR ESTA LINHA: -->
    <script src="js/config.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 0;
      }

      /* ============= BARRA SUPERIOR ============= */
      .top-bar {
        background: #f5f5f5;
        padding: 15px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .top-bar-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .top-bar-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #667eea;
      }

      .contador-jogos {
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .top-bar-actions {
        display: flex;
        gap: 10px;
      }

      .btn-top {
        padding: 8px 16px;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        transition: opacity 0.3s;
      }

      .btn-voltar {
        background: #667eea;
      }

      .btn-novo {
        background: #4caf50;
      }

      .btn-top:hover {
        opacity: 0.9;
      }

      /* ============= CONTAINER ============= */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 25px;
        padding-top: 10px;
      }

      header h1 {
        font-size: 2rem;
        margin-bottom: 8px;
      }

      header p {
        font-size: 1rem;
        opacity: 0.9;
      }

      /* ============= FILTROS SIMPLIFICADOS ============= */
      .filtros-simples {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .filtros-simples select,
      .filtros-simples input {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        flex: 1;
        min-width: 150px;
      }

      .filtros-simples select:focus,
      .filtros-simples input:focus {
        outline: none;
        border-color: #667eea;
      }

      /* ============= LISTA DE JOGOS ============= */
      .jogos-lista {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .jogo-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
      }

      .jogo-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
      }

      /* Borda colorida por loteria */
      .jogo-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
      }

      .jogo-card.megasena::before {
        background: #209869;
      }
      .jogo-card.lotofacil::before {
        background: #930089;
      }
      .jogo-card.quina::before {
        background: #260085;
      }
      .jogo-card.lotomania::before {
        background: #f78100;
      }
      .jogo-card.duplasena::before {
        background: #a61324;
      }
      .jogo-card.timemania::before {
        background: #00ff48;
      }
      .jogo-card.diadasorte::before {
        background: #cb852b;
      }
      .jogo-card.maismilionaria::before {
        background: #6bccef;
      }

      /* Cabe√ßalho do Card */
      .jogo-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .jogo-info-left {
        flex: 1;
      }

      .jogo-nome {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 4px;
      }

      .jogo-meta {
        font-size: 0.85rem;
        color: #666;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .jogo-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Acertos em Destaque */
      .jogo-acertos-destaque {
        text-align: right;
        min-width: 80px;
      }

      .acertos-numero {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        line-height: 1;
        margin-bottom: 4px;
      }

      .acertos-numero.premiado {
        color: #4caf50;
      }

      .acertos-label {
        font-size: 0.75rem;
        color: #999;
        text-transform: uppercase;
      }

      .badge-premiado {
        display: inline-block;
        background: linear-gradient(135deg, #ffd700 0%, #ff9800 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
        margin-top: 4px;
      }

      /* Grid de Dezenas */
      .jogo-dezenas-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 0;
      }

      .bola-numero {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.95rem;
        color: white;
      }

      /* Cores por loteria */
      .megasena .bola-numero {
        background: #209869;
      }
      .lotofacil .bola-numero {
        background: #930089;
      }
      .quina .bola-numero {
        background: #260085;
      }
      .lotomania .bola-numero {
        background: #f78100;
      }
      .duplasena .bola-numero {
        background: #a61324;
      }
      .timemania .bola-numero {
        background: #00ff48;
        color: #333;
      }
      .diadasorte .bola-numero {
        background: #cb852b;
      }
      .maismilionaria .bola-numero {
        background: #6bccef;
      }

      /* Checkbox de sele√ß√£o */
      .checkbox-jogo {
        position: absolute;
        top: 15px;
        right: 15px;
        transform: scale(1.3);
        cursor: pointer;
        accent-color: #667eea;
        z-index: 5;
      }

      /* ============= MENU DE A√á√ïES (3 PONTINHOS) ============= */
      .menu-acoes {
        position: relative;
      }

      .btn-menu {
        background: white;
        border: none;
        border-radius: 6px;
        padding: 8px 10px;
        cursor: pointer;
        font-size: 1.2rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        transition: background 0.2s;
      }

      .btn-menu:hover {
        background: #f0f0f0;
      }

      .menu-dropdown {
        position: absolute;
        top: 45px;
        right: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        min-width: 200px;
        display: none;
        flex-direction: column;
        z-index: 999;
        animation: fadeIn 0.2s ease-out;
      }

      .menu-dropdown button {
        background: none;
        border: none;
        padding: 12px 15px;
        text-align: left;
        font-size: 0.95rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.2s;
      }

      .menu-dropdown button:hover {
        background: #f5f5f5;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Bot√£o flutuante de excluir */
      #btn-excluir-selecionados {
        position: fixed;
        bottom: 25px;
        right: 25px;
        min-width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #e53935;
        color: white;
        font-size: 20px;
        font-weight: bold;
        border: none;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        transition: transform 0.2s, opacity 0.2s;
        display: none;
      }

      #btn-excluir-selecionados:hover {
        transform: scale(1.1);
        background: #c62828;
      }

      /* Toast notifications */
      .toast {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        color: white;
        font-weight: 600;
        animation: slideIn 0.3s ease-out;
      }

      .toast-success {
        background: #4caf50;
      }

      .toast-error {
        background: #f44336;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      /* ============= ESTADO VAZIO ============= */
      .estado-vazio {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .estado-vazio-icon {
        font-size: 5rem;
        margin-bottom: 20px;
      }

      .estado-vazio h2 {
        color: #333;
        margin-bottom: 10px;
      }

      .estado-vazio p {
        color: #666;
        margin-bottom: 25px;
      }

      /* ============= LOADING ============= */
      .loading {
        text-align: center;
        padding: 40px;
        color: white;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ============= RESPONSIVO ============= */
      @media (max-width: 768px) {
        header h1 {
          font-size: 1.5rem;
        }

        .jogo-header-row {
          flex-direction: column;
          gap: 15px;
        }

        .jogo-acertos-destaque {
          text-align: left;
        }

        .acertos-numero {
          font-size: 2rem;
        }

        .bola-numero {
          width: 38px;
          height: 38px;
          font-size: 0.85rem;
        }

        .filtros-simples {
          flex-direction: column;
        }

        .filtros-simples select,
        .filtros-simples input {
          width: 100%;
        }

        .checkbox-jogo {
          top: 10px;
          right: 10px;
        }

        #btn-excluir-selecionados {
          bottom: 15px;
          right: 15px;
          min-width: 50px;
          height: 50px;
          font-size: 16px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Barra Superior -->
    <div class="top-bar">
      <div class="top-bar-left">
        <div class="top-bar-title">üíæ Meus Jogos</div>
        <div class="contador-jogos" id="contador-jogos">0 jogos</div>
      </div>
      <div class="top-bar-actions">
        <a href="index.html" class="btn-top btn-voltar"
          ><i class="bi bi-arrow-left"></i
        ></a>
        <button
          class="btn-top btn-novo"
          onclick="location.href='gerador-combinacoes.html'"
        >
          <i class="bi bi-plus-circle"></i>
        </button>

        <div class="menu-acoes">
          <button class="btn-menu" onclick="toggleMenuAcoes(event)">
            <i class="bi bi-three-dots-vertical"></i>
          </button>

          <div class="menu-dropdown" id="menuDropdown">
            <button onclick="selecionarTodos()">
              <i class="bi bi-check-square"></i> Selecionar todos
            </button>
            <button onclick="limparSelecao()">
              <i class="bi bi-square"></i> Limpar sele√ß√£o
            </button>
            <button
              id="btn-copiar"
              onclick="copiarJogosSelecionados()"
              style="display: none"
            >
              <i class="bi bi-clipboard"></i> Copiar jogos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot√£o flutuante de excluir -->
    <button
      id="btn-excluir-selecionados"
      onclick="excluirSelecionados()"
      title="Excluir selecionados"
    >
      üóë
    </button>

    <div class="container">
      <header>
        <h1>üíæ Meus Jogos Salvos</h1>
        <p>Acertos atualizados automaticamente com o √∫ltimo concurso</p>
      </header>

      <!-- Filtros Simplificados -->
      <div class="filtros-simples">
        <select id="filtro-loteria" onchange="aplicarFiltros()">
          <option value="">üé∞ Todas as Loterias</option>
          <option value="megasena">üçÄ Mega-Sena</option>
          <option value="lotofacil">üéØ Lotof√°cil</option>
          <option value="quina">üåü Quina</option>
          <option value="lotomania">üé≤ Lotomania</option>
          <option value="duplasena">üé≠ Dupla-Sena</option>
          <option value="timemania">‚öΩ Timemania</option>
          <option value="diadasorte">üçÄ Dia de Sorte</option>
          <option value="maismilionaria">üí∞ +Milion√°ria</option>
        </select>
      </div>

      <!-- Loading -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Conferindo jogos automaticamente...</p>
      </div>

      <!-- Lista de Jogos -->
      <div id="jogos-lista" class="jogos-lista"></div>

      <!-- Estado Vazio -->
      <div id="estado-vazio" class="estado-vazio" style="display: none">
        <div class="estado-vazio-icon">üé≤</div>
        <h2>Nenhum jogo salvo ainda</h2>
        <p>Comece criando seu primeiro jogo da sorte!</p>
        <button
          class="btn-top btn-novo"
          onclick="location.href='gerar-jogos.html'"
        >
          + Criar Primeiro Jogo
        </button>
      </div>
    </div>

    <script>
      let jogos = [];
      let jogosSelecionados = new Set();

      const LOTERIAS_NOMES = {
        megasena: "Mega-Sena",
        lotofacil: "Lotof√°cil",
        quina: "Quina",
        lotomania: "Lotomania",
        duplasena: "Dupla-Sena",
        timemania: "Timemania",
        diadasorte: "Dia de Sorte",
        maismilionaria: "+Milion√°ria",
      };

      // ============================================
      // TOAST NOTIFICATIONS
      // ============================================
      function mostrarToast(mensagem, tipo = "success") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${tipo}`;
        toast.textContent = mensagem;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease-in";
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }

      // ============================================
      // CONTADOR DE JOGOS
      // ============================================
      function atualizarContador() {
        const contador = document.getElementById("contador-jogos");

        // ‚úÖ CORRE√á√ÉO: Verificar se elemento existe
        if (!contador) {
          console.warn("‚ö†Ô∏è Elemento contador-jogos n√£o encontrado no HTML");
          return;
        }

        const total = jogos.length;

        if (total === 0) {
          contador.textContent = "0 jogos";
        } else if (total === 1) {
          contador.textContent = "1 jogo";
        } else {
          contador.textContent = `${total} jogos`;
        }
      }

      // ============================================
      // SELE√á√ÉO DE JOGOS
      // ============================================
      function toggleSelecao(id, checked) {
        if (checked) {
          jogosSelecionados.add(id);
        } else {
          jogosSelecionados.delete(id);
        }

        atualizarBotaoExcluir();
        atualizarDropdownAcoes();
      }

      function atualizarBotaoExcluir() {
        const btn = document.getElementById("btn-excluir-selecionados");
        if (jogosSelecionados.size > 0) {
          btn.innerHTML = `üóë ${jogosSelecionados.size}`;
          btn.style.display = "block";
        } else {
          btn.style.display = "none";
        }
      }

      function atualizarDropdownAcoes() {
        const btnCopiar = document.getElementById("btn-copiar");
        if (!btnCopiar) return;
        btnCopiar.style.display = jogosSelecionados.size > 0 ? "flex" : "none";
      }

      function selecionarTodos() {
        jogos.forEach((j) => jogosSelecionados.add(j.id));

        document.querySelectorAll(".checkbox-jogo").forEach((cb) => {
          cb.checked = true;
        });

        atualizarBotaoExcluir();
        atualizarDropdownAcoes();

        // Fechar menu
        document.getElementById("menuDropdown").style.display = "none";
      }

      function limparSelecao() {
        jogosSelecionados.clear();

        document.querySelectorAll(".checkbox-jogo").forEach((cb) => {
          cb.checked = false;
        });

        atualizarBotaoExcluir();
        atualizarDropdownAcoes();

        // Fechar menu
        document.getElementById("menuDropdown").style.display = "none";
      }

      // ============================================
      // COPIAR JOGOS
      // ============================================
      function copiarJogosSelecionados() {
        if (jogosSelecionados.size === 0) return;

        const jogosParaCopiar = jogos
          .filter((j) => jogosSelecionados.has(j.id))
          .map((j) =>
            j.dezenas.map((d) => d.toString().padStart(2, "0")).join(" ")
          )
          .join("\n");

        navigator.clipboard
          .writeText(jogosParaCopiar)
          .then(() => {
            mostrarToast(
              `‚úÖ ${jogosSelecionados.size} jogo(s) copiado(s)!`,
              "success"
            );
            document.getElementById("menuDropdown").style.display = "none";
          })
          .catch(() => {
            mostrarToast("‚ùå Erro ao copiar jogos", "error");
          });
      }

      // ============================================
      // EXCLUIR JOGOS
      // ============================================
      async function excluirSelecionados() {
        if (jogosSelecionados.size === 0) return;

        const confirmar = confirm(
          `Deseja excluir ${jogosSelecionados.size} jogo(s)? Essa a√ß√£o n√£o pode ser desfeita.`
        );

        if (!confirmar) return;

        try {
          const token = localStorage.getItem("token");

          // üîß CORRE√á√ÉO: Usar endpoint de exclus√£o em lote
          const response = await fetch(`${API_URL}/api/jogos/excluir-lote`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ids: Array.from(jogosSelecionados),
            }),
          });

          const data = await response.json();

          if (data.success) {
            mostrarToast(
              `‚úÖ ${data.data.excluidos} jogo(s) exclu√≠do(s)!`,
              "success"
            );

            jogosSelecionados.clear();
            atualizarBotaoExcluir();
            atualizarDropdownAcoes();

            await carregarJogos();
          } else {
            mostrarToast("‚ùå " + data.message, "error");
          }
        } catch (error) {
          console.error(error);
          mostrarToast("‚ùå Erro ao excluir jogos", "error");
        }
      }

      // ============================================
      // MENU 3 PONTINHOS
      // ============================================
      function toggleMenuAcoes(event) {
        event.stopPropagation();
        const menu = document.getElementById("menuDropdown");
        menu.style.display = menu.style.display === "flex" ? "none" : "flex";
      }

      // Fechar menu ao clicar fora
      document.addEventListener("click", () => {
        const menu = document.getElementById("menuDropdown");
        if (menu) menu.style.display = "none";
      });

      // ============================================
      // FUN√á√ÉO carregarJogos() COM DEBUG COMPLETO
      // ============================================

      async function carregarJogos() {
        console.log("üöÄ [1/5] Iniciando carregamento de jogos...");

        document.getElementById("loading").style.display = "block";
        document.getElementById("jogos-lista").innerHTML = "";
        document.getElementById("estado-vazio").style.display = "none";

        try {
          const token = localStorage.getItem("token");
          console.log(
            "üîë [2/5] Token obtido:",
            token ? "‚úÖ OK" : "‚ùå FALTANDO"
          );

          if (!token) {
            throw new Error("Token n√£o encontrado. Fa√ßa login novamente.");
          }

          // PASSO 1: Conferir todos os jogos
          console.log("üîÑ [3/5] Conferindo todos os jogos...");

          try {
            const conferirResponse = await fetch(
              `${API_URL}/api/jogos/conferir-todos-simples`,
              {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
              }
            );

            console.log("üì° Status conferir:", conferirResponse.status);

            if (!conferirResponse.ok) {
              console.error(
                "‚ùå Erro ao conferir jogos:",
                conferirResponse.statusText
              );
              // Continua mesmo assim
            } else {
              const conferirData = await conferirResponse.json();
              console.log("‚úÖ Conferidos:", conferirData);
            }
          } catch (conferirError) {
            console.error("‚ùå Erro ao conferir (ignorando):", conferirError);
            // Continua mesmo assim
          }

          // PASSO 2: Carregar jogos
          console.log("üì° [4/5] Carregando jogos do servidor...");

          const url = `${API_URL}/api/jogos/meus-jogos?limit=10000`;
          console.log("üìç URL:", url);

          const response = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });

          console.log("üì° Status:", response.status);
          console.log("üì° Status Text:", response.statusText);

          // Verificar se a resposta √© OK
          if (!response.ok) {
            const errorText = await response.text();
            console.error("‚ùå Resposta n√£o OK:", errorText);
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
          }

          // Tentar parsear JSON
          let data;
          try {
            data = await response.json();
            console.log("üì¶ Dados recebidos:", data);
          } catch (jsonError) {
            console.error("‚ùå Erro ao parsear JSON:", jsonError);
            throw new Error("Resposta inv√°lida do servidor");
          }

          // Verificar se data.success existe
          if (data.success) {
            jogos = data.data;

            console.log("‚úÖ [5/5] Total de jogos carregados:", jogos.length);
            console.log("üìä Total no servidor:", data.total || jogos.length);
            console.log("üìã Primeiro jogo:", jogos[0]);

            // Ordenar por acertos
            jogos.sort((a, b) => {
              const acertosA = a.acertos || 0;
              const acertosB = b.acertos || 0;
              return acertosB - acertosA;
            });

            document.getElementById("loading").style.display = "none";

            if (jogos.length === 0) {
              console.log("‚ö†Ô∏è Nenhum jogo encontrado");
              document.getElementById("estado-vazio").style.display = "block";
            } else {
              console.log("üé® Renderizando", jogos.length, "jogos...");
              renderizarJogos(jogos);
            }

            atualizarContador();

            console.log("‚úÖ Carregamento conclu√≠do com sucesso!");
          } else {
            console.error("‚ùå data.success = false:", data.message);
            throw new Error(data.message || "Erro desconhecido");
          }
        } catch (error) {
          console.error("‚ùå ========================================");
          console.error("‚ùå ERRO CAPTURADO NA LINHA 888:");
          console.error("‚ùå Tipo:", error.name);
          console.error("‚ùå Mensagem:", error.message);
          console.error("‚ùå Stack:", error.stack);
          console.error("‚ùå ========================================");

          document.getElementById("loading").style.display = "none";
          mostrarToast("‚ùå Erro ao carregar jogos: " + error.message, "error");

          // Mostrar erro na tela tamb√©m
          document.getElementById("jogos-lista").innerHTML = `
      <div class="estado-vazio">
        <div class="estado-vazio-icon">‚ö†Ô∏è</div>
        <h2>Erro ao Carregar Jogos</h2>
        <p style="color: #f44336; font-family: monospace;">
          ${error.message}
        </p>
        <p>Verifique o console (F12) para mais detalhes.</p>
        <button class="btn-top btn-atualizar" onclick="carregarJogos()">
          üîÑ Tentar Novamente
        </button>
      </div>
    `;
        }
      }

      // ============================================
      // VERS√ÉO ALTERNATIVA: TENTAR LIMIT MENOR SE FALHAR
      // ============================================

      async function carregarJogosComFallback() {
        const limits = [10000, 5000, 1000, 500, 100];

        for (const limit of limits) {
          try {
            console.log(`üîÑ Tentando carregar com limit=${limit}...`);

            const token = localStorage.getItem("token");
            const response = await fetch(
              `${API_URL}/api/jogos/meus-jogos?limit=${limit}`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );

            if (response.ok) {
              const data = await response.json();

              if (data.success) {
                jogos = data.data;
                console.log(
                  `‚úÖ Sucesso com limit=${limit}! Total: ${jogos.length}`
                );

                // Avisa se h√° mais jogos
                if (data.total && data.total > jogos.length) {
                  console.warn(
                    `‚ö†Ô∏è Aten√ß√£o: H√° ${data.total} jogos, mas s√≥ carregou ${jogos.length}`
                  );
                  mostrarToast(
                    `‚ö†Ô∏è Carregados ${jogos.length} de ${data.total} jogos`,
                    "warning"
                  );
                }

                renderizarJogos(jogos);
                atualizarContador();
                return; // SUCESSO!
              }
            }
          } catch (error) {
            console.error(`‚ùå Falhou com limit=${limit}:`, error);
            continue; // Tenta pr√≥ximo limit
          }
        }

        // Se chegou aqui, falhou com todos os limits
        console.error("‚ùå Falhou com TODOS os limits!");
        mostrarToast("‚ùå N√£o foi poss√≠vel carregar os jogos", "error");
      }

      // ============================================
      // TESTE DE CONEX√ÉO
      // ============================================

      async function testarConexaoBackend() {
        console.log("üîç Testando conex√£o com backend...");

        const token = localStorage.getItem("token");

        // Teste 1: Backend est√° online?
        try {
          console.log("üì° Teste 1: Verificando se backend responde...");
          const response = await fetch(
            `${API_URL}/api/jogos/meus-jogos?limit=1`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          console.log("‚úÖ Backend respondeu! Status:", response.status);

          if (response.ok) {
            const data = await response.json();
            console.log("‚úÖ JSON v√°lido:", data);

            if (data.success) {
              console.log(
                "‚úÖ Endpoint funcionando! Total de jogos:",
                data.total
              );
              return true;
            } else {
              console.error(
                "‚ùå Endpoint retornou success=false:",
                data.message
              );
              return false;
            }
          } else {
            console.error(
              "‚ùå Status n√£o OK:",
              response.status,
              response.statusText
            );
            return false;
          }
        } catch (error) {
          console.error("‚ùå Erro de conex√£o:", error);
          return false;
        }
      }

      async function conferirTodos() {
        const btnAtualizar = document.querySelector(".btn-atualizar");
        btnAtualizar.textContent = "‚è≥ Atualizando...";
        btnAtualizar.disabled = true;

        try {
          await carregarJogos();
          btnAtualizar.textContent = "‚úÖ Atualizado!";
          setTimeout(() => {
            btnAtualizar.textContent = "üîÑ Atualizar";
            btnAtualizar.disabled = false;
          }, 2000);
        } catch (error) {
          btnAtualizar.textContent = "‚ùå Erro";
          setTimeout(() => {
            btnAtualizar.textContent = "üîÑ Atualizar";
            btnAtualizar.disabled = false;
          }, 2000);
        }
      }

      function renderizarJogos(jogosParaRenderizar) {
        const lista = document.getElementById("jogos-lista");

        if (jogosParaRenderizar.length === 0) {
          lista.innerHTML =
            '<div class="estado-vazio"><p>Nenhum jogo encontrado com os filtros aplicados.</p></div>';
          return;
        }

        lista.innerHTML = jogosParaRenderizar
          .map((jogo) => {
            const dezenas = jogo.dezenas
              .map(
                (d) =>
                  `<div class="bola-numero">${d
                    .toString()
                    .padStart(2, "0")}</div>`
              )
              .join("");

            const data = new Date(jogo.created_at).toLocaleDateString("pt-BR");
            const loteriaNome = LOTERIAS_NOMES[jogo.loteria] || jogo.loteria;

            // Acertos
            const temAcertos = jogo.conferido && jogo.acertos !== null;
            const acertos = temAcertos ? jogo.acertos : "-";
            const regrasPremiacao = {
              megasena: 4,
              lotofacil: 11,
              quina: 2,
              lotomania: 0,
              duplasena: 3,
              timemania: 3,
              diadasorte: 4,
              maismilionaria: 4,
            };

            let premiado = false;

            if (temAcertos) {
              if (jogo.loteria === "lotomania") {
                premiado = jogo.acertos === 0 || jogo.acertos >= 15;
              } else {
                premiado = jogo.acertos >= (regrasPremiacao[jogo.loteria] || 4);
              }
            }

            return `
          <div class="jogo-card ${jogo.loteria}">
            <input
              type="checkbox"
              class="checkbox-jogo"
              data-id="${jogo.id}"
              onchange="toggleSelecao(${jogo.id}, this.checked)"
            />
            
            <div class="jogo-header-row">
              <div class="jogo-info-left">
                <div class="jogo-nome">
                  ${jogo.label || jogo.nome_jogo || "Sem nome"}
                </div>

                <div class="jogo-meta">
                  <span>üé∞ ${loteriaNome}</span>
                  <span>üìÖ ${data}</span>
                  ${
                    jogo.concurso_conferido
                      ? `<span>üéØ Concurso ${jogo.concurso_conferido}</span>`
                      : ""
                  }
                </div>
              </div>

              <div class="jogo-acertos-destaque">
                <div class="acertos-numero ${
                  premiado ? "premiado" : ""
                }">${acertos}</div>
                <div class="acertos-label">acertos</div>
                ${
                  premiado
                    ? '<div class="badge-premiado">üèÜ PREMIADO</div>'
                    : ""
                }
              </div>
            </div>

            <div class="jogo-dezenas-grid ${jogo.loteria}">
              ${dezenas}
            </div>
          </div>
        `;
          })
          .join("");
      }

      function aplicarFiltros() {
        const loteria = document.getElementById("filtro-loteria").value;

        let jogosFiltrados = [...jogos];

        if (loteria) {
          jogosFiltrados = jogosFiltrados.filter((j) => j.loteria === loteria);
        }

        // Sempre ordenar por acertos
        jogosFiltrados.sort((a, b) => {
          const acertosA = a.acertos || 0;
          const acertosB = b.acertos || 0;
          return acertosB - acertosA;
        });

        renderizarJogos(jogosFiltrados);

        // Atualizar contador com jogos filtrados
        const contador = document.getElementById("contador-jogos");
        if (jogosFiltrados.length === 1) {
          contador.textContent = "1 jogo";
        } else {
          contador.textContent = `${jogosFiltrados.length} jogos`;
        }
      }

      // Verificar autentica√ß√£o e carregar jogos
      window.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Voc√™ precisa fazer login primeiro!");
          window.location.href = "login.html";
          return;
        }

        carregarJogos();
      });
    </script>
    <script src="js/auth-check.js"></script>
  </body>
</html>
