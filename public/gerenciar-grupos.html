<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìÅ Gerenciar Grupos</title>

    <script src="js/config.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .header {
            background: white;
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .15);
        }

        .header h1 {
            font-size: 1.1rem;
            margin: 0 auto;
            color: #667eea;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            color: #667eea;
            cursor: pointer;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, .2);
        }

        select,
        input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
            font-size: .95rem;
        }

        .novo-grupo {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .novo-grupo input {
            flex: 1;
            margin-bottom: 0;
        }

        .novo-grupo button {
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            background: #4caf50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .lista-grupos {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .grupo-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-radius: 8px;
            background: #f5f5f5;
            margin-bottom: 8px;
        }

        .grupo-nome {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            overflow: hidden;
        }

        .grupo-nome span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            display: inline-block;
        }

        .grupo-acoes button {
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            margin-left: 8px;
        }

        .grupo-acoes button:hover {
            opacity: 0.7;
        }

        .vazio {
            text-align: center;
            color: #777;
            margin-top: 20px;
        }

        /* ============================
       MODAIS (estilo app mobile)
       ============================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            width: 100%;
            max-width: 420px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
            overflow: hidden;
            animation: pop .18s ease-out;
        }

        @keyframes pop {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: #f7f7ff;
            border-bottom: 1px solid #eee;
        }

        .modal-header i {
            font-size: 1.25rem;
            color: #667eea;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.05rem;
            color: #333;
        }

        .modal-body {
            padding: 16px;
            color: #444;
        }

        .modal-body p {
            margin: 0 0 12px;
            line-height: 1.35;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 12px 16px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .btn-modal {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 700;
            cursor: pointer;
            transition: transform .08s, opacity .2s;
        }

        .btn-modal:active {
            transform: scale(0.98);
        }

        .btn-cancelar {
            background: #f0f0f0;
            color: #333;
        }

        .btn-salvar {
            background: #667eea;
            color: white;
        }

        .btn-editar {
            color: #667eea;
            background: transparent;
            border: none;
            font-size: 1.15rem;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: background 0.2s, transform 0.15s;
        }

        .btn-editar:hover {
            background: rgba(53, 173, 229, 0.12);
            transform: scale(1.05);
        }

        .btn-editar:active {
            transform: scale(0.95);
        }

        .btn-excluir {
            color: #e53935;
            background: transparent;
            border: none;
            font-size: 1.15rem;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: background 0.2s, transform 0.15s;
        }

        .btn-excluir:hover {
            background: rgba(229, 57, 53, 0.12);
            transform: scale(1.05);
        }

        .btn-excluir:active {
            transform: scale(0.95);
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 2px solid #ddd;
            font-size: .95rem;
            outline: none;
        }

        .modal-input:focus {
            border-color: #667eea;
        }

        .texto-destaque {
            font-weight: 800;
            color: #111;
            word-break: break-word;
        }

        .subtexto {
            font-size: .9rem;
            color: #666;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <button class="icon-btn" onclick="history.back()">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h1>Gerenciar Grupos</h1>
    </div>

    <div class="container">

        <!-- LOTERIA -->
        <select id="select-loteria" onchange="carregarGrupos()">
            <option value="">üé∞ Selecione a loteria</option>
            <option value="megasena">üçÄ Mega-Sena</option>
            <option value="lotofacil">üéØ Lotof√°cil</option>
            <option value="quina">üåü Quina</option>
            <option value="lotomania">üé≤ Lotomania</option>
            <option value="duplasena">üé≠ Dupla-Sena</option>
            <option value="timemania">‚öΩ Timemania</option>
            <option value="diadasorte">üçÄ Dia de Sorte</option>
            <option value="maismilionaria">üí∞ +Milion√°ria</option>
        </select>

        <!-- NOVO GRUPO -->
        <div class="novo-grupo">
            <input id="input-novo-grupo" placeholder="Nome do novo grupo" />
            <button onclick="criarGrupo()">Criar</button>
        </div>

        <!-- LISTA -->
        <div id="lista-grupos" class="lista-grupos"></div>

        <div id="estado-vazio" class="vazio" style="display:none">
            Nenhum grupo criado para esta loteria
        </div>

    </div>

    <!-- ============================
       MODAL EDITAR
       ============================ -->
    <div id="modal-editar" class="modal-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="titulo-editar">
            <div class="modal-header">
                <i class="bi bi-pencil-square"></i>
                <h3 id="titulo-editar">Editar Nome do Grupo</h3>
            </div>
            <div class="modal-body">
                <p class="subtexto">Digite o novo nome para o grupo:</p>
                <input id="input-editar-nome" class="modal-input" type="text" placeholder="Ex: üçÄüî• Palpite 1" />
                <p class="subtexto" style="margin-top:10px;">
                    Atual: <span id="editar-nome-atual" class="texto-destaque"></span>
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancelar" onclick="fecharModalEditar()">CANCELAR</button>
                <button class="btn-modal btn-salvar" onclick="confirmarEditarGrupo()">SALVAR</button>
            </div>
        </div>
    </div>

    <!-- ============================
       MODAL EXCLUIR
       ============================ -->
    <div id="modal-excluir" class="modal-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="titulo-excluir">
            <div class="modal-header">
                <i class="bi bi-trash3"></i>
                <h3 id="titulo-excluir">Excluir Grupo</h3>
            </div>
            <div class="modal-body">
                <p>Deseja realmente excluir o grupo:</p>
                <p class="texto-destaque" id="excluir-nome"></p>
                <p class="subtexto">Os jogos relacionados a ele ser√£o associados ao grupo padr√£o.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancelar" onclick="fecharModalExcluir()">N√ÉO</button>
                <button class="btn-modal btn-excluir" onclick="confirmarExcluirGrupo()">SIM</button>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // ESTADO (para os modais)
        // ============================
        let grupoEmEdicao = null;   // string com o nome atual
        let grupoEmExclusao = null; // string com o nome

        // ============================
        // HELPERS (token / loteria)
        // ============================
        function getToken() {
            return localStorage.getItem("token");
        }

        function getLoteriaSelecionada() {
            return document.getElementById("select-loteria").value;
        }

        // ============================
        // CARREGAR GRUPOS
        // ============================
        async function carregarGrupos() {
            const loteria = getLoteriaSelecionada();
            const token = getToken();

            const lista = document.getElementById("lista-grupos");
            const vazio = document.getElementById("estado-vazio");

            if (!loteria) {
                lista.innerHTML = "";
                vazio.style.display = "none";
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/jogos/grupos?loteria=${encodeURIComponent(loteria)}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const data = await res.json();
                console.log("üì• Grupos:", data);

                if (!data.success || !Array.isArray(data.data) || data.data.length === 0) {
                    lista.innerHTML = "";
                    vazio.style.display = "block";
                    return;
                }

                vazio.style.display = "none";

                // üî• IMPORTANT√çSSIMO: nada de injetar nome em onclick (pra n√£o quebrar com aspas/emoji)
                lista.innerHTML = data.data.map((nome) => `
          <div class="grupo-item">
            <div class="grupo-nome" title="${escapeHtml(nome)}">
              üìÅ <span>${escapeHtml(nome)}</span>
            </div>
            <div class="grupo-acoes">
              <button class="btn-editar" data-nome="${escapeAttr(nome)}" title="Editar"><i class="bi bi-pencil-square"></i></button>
              <button class="btn-excluir" data-nome="${escapeAttr(nome)}" title="Excluir"><i class="bi bi-trash3-fill"></i></button>
            </div>
          </div>
        `).join("");

                // bind dos bot√µes
                document.querySelectorAll(".btn-editar").forEach((btn) => {
                    btn.addEventListener("click", () => abrirModalEditar(btn.dataset.nome));
                });

                document.querySelectorAll(".btn-excluir").forEach((btn) => {
                    btn.addEventListener("click", () => abrirModalExcluir(btn.dataset.nome));
                });

            } catch (err) {
                console.error(err);
                lista.innerHTML = "<p>Erro ao carregar grupos</p>";
                vazio.style.display = "none";
            }
        }

        // ============================
        // CRIAR GRUPO
        // ============================
        async function criarGrupo() {
            const nome = document.getElementById("input-novo-grupo").value.trim();
            const loteria = getLoteriaSelecionada();
            const token = getToken();

            if (!loteria) {
                alert("Selecione a loteria primeiro");
                return;
            }

            if (!nome) {
                alert("Digite um nome para o grupo");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/jogos/grupos`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ nome, loteria }),
                });

                const data = await res.json();

                if (!data.success) {
                    alert(data.message || "Erro ao criar grupo");
                    return;
                }

                document.getElementById("input-novo-grupo").value = "";
                await carregarGrupos();
            } catch (err) {
                console.error(err);
                alert("Erro ao salvar grupo");
            }
        }

        // ============================
        // MODAL EDITAR (abrir/fechar)
        // ============================
        function abrirModalEditar(nomeAtual) {
            grupoEmEdicao = nomeAtual;

            const modal = document.getElementById("modal-editar");
            const input = document.getElementById("input-editar-nome");
            const atual = document.getElementById("editar-nome-atual");

            atual.textContent = nomeAtual;
            input.value = nomeAtual;

            modal.classList.add("active");
            modal.setAttribute("aria-hidden", "false");

            setTimeout(() => input.focus(), 80);
        }

        function fecharModalEditar() {
            const modal = document.getElementById("modal-editar");
            modal.classList.remove("active");
            modal.setAttribute("aria-hidden", "true");
            grupoEmEdicao = null;
        }

        async function confirmarEditarGrupo() {
            const loteria = getLoteriaSelecionada();
            if (!loteria || !grupoEmEdicao) return;

            const input = document.getElementById("input-editar-nome");
            const novoNome = (input.value || "").trim();

            if (!novoNome) {
                alert("Digite um novo nome.");
                return;
            }

            if (novoNome === grupoEmEdicao) {
                fecharModalEditar();
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/jogos/grupos`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${getToken()}`,
                    },
                    body: JSON.stringify({
                        loteria,
                        nome_antigo: grupoEmEdicao,
                        nome_novo: novoNome,
                    }),
                });

                const data = await res.json();

                if (data.success) {
                    fecharModalEditar();
                    await carregarGrupos();
                } else {
                    alert(data.message || "Erro ao atualizar");
                }
            } catch (err) {
                console.error(err);
                alert("Erro ao atualizar grupo");
            }
        }

        // ============================
        // MODAL EXCLUIR (abrir/fechar)
        // ============================
        function abrirModalExcluir(nome) {
            grupoEmExclusao = nome;

            const modal = document.getElementById("modal-excluir");
            const nomeEl = document.getElementById("excluir-nome");

            nomeEl.textContent = nome;

            modal.classList.add("active");
            modal.setAttribute("aria-hidden", "false");
        }

        function fecharModalExcluir() {
            const modal = document.getElementById("modal-excluir");
            modal.classList.remove("active");
            modal.setAttribute("aria-hidden", "true");
            grupoEmExclusao = null;
        }

        async function confirmarExcluirGrupo() {
            const loteria = getLoteriaSelecionada();
            if (!loteria || !grupoEmExclusao) return;

            try {
                const res = await fetch(`${API_URL}/api/jogos/grupos`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${getToken()}`,
                    },
                    body: JSON.stringify({ loteria, nome: grupoEmExclusao }),
                });

                const data = await res.json();

                if (data.success) {
                    fecharModalExcluir();
                    await carregarGrupos();
                } else {
                    alert(data.message || "Erro ao remover");
                }
            } catch (err) {
                console.error(err);
                alert("Erro ao remover grupo");
            }
        }

        // ============================
        // FECHAR MODAL: clique fora + ESC
        // ============================
        function bindModalFecharFora() {
            const modalEditar = document.getElementById("modal-editar");
            const modalExcluir = document.getElementById("modal-excluir");

            [modalEditar, modalExcluir].forEach((overlay) => {
                overlay.addEventListener("click", (e) => {
                    if (e.target === overlay) {
                        if (overlay.id === "modal-editar") fecharModalEditar();
                        if (overlay.id === "modal-excluir") fecharModalExcluir();
                    }
                });
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    fecharModalEditar();
                    fecharModalExcluir();
                }
            });
        }

        // ============================
        // SANITIZA√á√ÉO (pra evitar quebrar HTML)
        // ============================
        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function escapeAttr(str) {
            // para usar em data-atributos
            return escapeHtml(str);
        }

        // ============================
        // INIT
        // ============================
        document.addEventListener("DOMContentLoaded", () => {
            bindModalFecharFora();
            carregarGrupos();
        });
    </script>
    <script src="js/auth-check.js"></script>
    <script>
        // Autentica√ß√£o b√°sica
        if (verificarAutenticacao()) {
            // üö´ Verifica√ß√£o do plano
            verificarPlanoPro();
        }
    </script>

</body>

</html>